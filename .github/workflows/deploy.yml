name: Deploy

on:
  workflow_run:
    workflows: ["Release"]
    branches:
      - main
    types:
      - completed
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Tag image yang akan di-deploy"
        required: false
        default: "latest"

permissions:
  contents: read
  packages: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  CONTAINER_NAME: ka-el
  IMAGE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.image_tag || 'latest' }}

jobs:
  migrate:
    name: Migrate Production Database
    if: >
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.GHCR_USER }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Prisma migrations using app image
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          IMAGE_TAG="${{ env.IMAGE_TAG }}"
          if [ -z "$IMAGE_TAG" ]; then IMAGE_TAG="latest"; fi

          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"

          echo "Using image: $IMAGE"
          echo "Running Prisma migrate against AWS Postgres..."

          docker run --rm \
            -e DATABASE_URL="$DATABASE_URL" \
            "$IMAGE" \
            bunx prisma migrate deploy

  deploy:
    name: Deploy to Production Server
    needs: migrate
    if: >
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Jalankan deployment via SSH
        uses: appleboy/ssh-action@v1.0.1
        env:
          GHCR_USER: ${{ secrets.GHCR_USER }}
          GHCR_PAT: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}

          envs: GHCR_USER,GHCR_PAT,IMAGE_TAG

          script: |
            cd /var/www/ka-el

            echo "Login ke GHCR..."
            echo "${GHCR_PAT}" | docker login ${{ env.REGISTRY }} -u "${GHCR_USER}" --password-stdin

            if [ -z "$IMAGE_TAG" ]; then IMAGE_TAG="latest"; fi
            echo "Menggunakan IMAGE_TAG=${IMAGE_TAG}"

            echo "Pull image terbaru via docker compose..."
            IMAGE_TAG="${IMAGE_TAG}" docker compose pull

            echo "Rebuild & start containers..."
            IMAGE_TAG="${IMAGE_TAG}" docker compose up -d

            echo "Deployment selesai. (Migrasi sudah dijalankan di job migrate)"
            docker logout ${{ env.REGISTRY }}
